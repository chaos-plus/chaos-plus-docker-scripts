# Loki 3.5.7 配置文件 - 阿里云 OSS 存储版本
# 使用阿里云 OSS 作为对象存储后端

auth_enabled: false

server:
  http_listen_address: 0.0.0.0
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info
  log_format: logfmt
  grpc_server_max_recv_msg_size: 104857600  # 100MB
  grpc_server_max_send_msg_size: 104857600  # 100MB
  grpc_server_max_concurrent_streams: 1000

# 通用配置
common:
  instance_addr: 127.0.0.1
  path_prefix: /loki
  replication_factor: 1
  
  # 使用阿里云 OSS 存储
  storage:
    s3:
      # 阿里云 OSS Endpoint (根据区域选择)
      # 华东1(杭州): oss-cn-hangzhou.aliyuncs.com
      # 华北2(北京): oss-cn-beijing.aliyuncs.com
      # 华南1(深圳): oss-cn-shenzhen.aliyuncs.com
      # 亚太东南1(新加坡): oss-ap-southeast-1.aliyuncs.com
      # 亚太东南3(吉隆坡): oss-ap-southeast-3.aliyuncs.com
      endpoint: ${OSS_ENDPOINT:-oss-ap-southeast-3.aliyuncs.com}
      
      # OSS Bucket 名称
      bucketnames: ${OSS_BUCKET:-loki-data}
      
      # 阿里云 AccessKey
      access_key_id: ${OSS_ACCESS_KEY_ID}
      secret_access_key: ${OSS_SECRET_ACCESS_KEY}
      
      # OSS 配置
      region: ${OSS_REGION:-ap-southeast-3}
      insecure: false
      http_config:
        idle_conn_timeout: 90s
        response_header_timeout: 0s
        insecure_skip_verify: false
      
      # 阿里云 OSS 必须使用虚拟主机样式（Virtual Hosted Style）
      # AWS S3 用 true，阿里云 OSS 用 false
      s3forcepathstyle: ${OSS_S3FORCEPATHSTYLE:-false}
  
  # 环形拓扑配置
  ring:
    instance_addr: 127.0.0.1
    kvstore:
      store: inmemory
    heartbeat_timeout: 1m

# 存储架构配置（TSDB + v13 schema）
schema_config:
  configs:
    - from: 2024-01-01
      store: tsdb
      object_store: s3  # 使用 S3 兼容存储（OSS）
      schema: v13
      index:
        prefix: loki_index_
        period: 24h

# 存储配置
storage_config:
  # TSDB 配置
  tsdb_shipper:
    # 本地缓存目录（临时索引）
    active_index_directory: /loki/tsdb-index
    cache_location: /loki/tsdb-cache
  
  # AWS S3 / 阿里云 OSS 配置
  aws:
    # S3 兼容配置
    s3: ${OSS_ENDPOINT:-oss-ap-southeast-3.aliyuncs.com}
    region: ${OSS_REGION:-ap-southeast-3}
    access_key_id: ${OSS_ACCESS_KEY_ID}
    secret_access_key: ${OSS_SECRET_ACCESS_KEY}
    s3forcepathstyle: false  # 阿里云 OSS 必须用 false
    insecure: false
    
    # HTTP 配置
    http_config:
      idle_conn_timeout: 90s
      response_header_timeout: 0s
      insecure_skip_verify: false

# 查询范围配置
query_range:
  align_queries_with_step: true
  max_retries: 5
  parallelise_shardable_queries: true
  cache_results: true
  
  # 结果缓存（使用嵌入式缓存）
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 500
        ttl: 24h

# 性能和限制配置
limits_config:
  # 启用指标聚合
  metric_aggregation_enabled: true
  
  # 数据保留
  retention_period: 720h  # 30 天
  
  # 写入限制
  ingestion_rate_strategy: local
  ingestion_rate_mb: 20
  ingestion_burst_size_mb: 30
  per_stream_rate_limit: 10MB
  per_stream_rate_limit_burst: 20MB
  max_line_size: 256KB
  max_line_size_truncate: true
  
  # 查询限制
  max_query_length: 721h
  max_query_lookback: 720h
  max_query_parallelism: 32
  max_query_series: 5000
  max_streams_per_user: 0
  max_global_streams_per_user: 10000
  max_entries_limit_per_query: 10000
  max_chunks_per_query: 2000000
  
  # 标签限制
  max_label_name_length: 1024
  max_label_value_length: 2048
  max_label_names_per_series: 30
  
  # 分片配置
  split_queries_by_interval: 30m
  min_sharding_lookback: 0s
  
  # 拒绝旧数据
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  creation_grace_period: 10m
  
  # 链路追踪支持
  unordered_writes: true

# Chunk 存储配置
chunk_store_config:
  chunk_cache_config:
    embedded_cache:
      enabled: true
      max_size_mb: 1024

# Compactor 配置（数据压缩和清理）
compactor:
  working_directory: /loki/compactor
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150
  delete_request_store: s3

# 查询器配置
querier:
  max_concurrent: 20
  query_ingesters_within: 3h

# 前端配置（查询优化）
frontend:
  log_queries_longer_than: 5s
  compress_responses: true
  max_outstanding_per_tenant: 2048
  encoding: protobuf
  tail_proxy_url: http://localhost:3100

# Ingester 配置
ingester:
  chunk_idle_period: 30m
  chunk_block_size: 262144
  chunk_retain_period: 1m
  max_chunk_age: 2h
  wal:
    enabled: true
    dir: /loki/wal
    flush_on_shutdown: true

# Pattern Ingester 配置（日志模式识别）
pattern_ingester:
  enabled: true
  metric_aggregation:
    loki_address: localhost:3100

# Ruler 配置（告警规则）
ruler:
  enable_api: true
  enable_alertmanager_v2: true
  alertmanager_url: ${ALERTMANAGER_URL:-}
  
  storage:
    type: s3
    s3:
      bucketnames: ${OSS_BUCKET_RULER:-loki-ruler}
      endpoint: ${OSS_ENDPOINT:-oss-ap-southeast-3.aliyuncs.com}
      region: ${OSS_REGION:-ap-southeast-3}
      access_key_id: ${OSS_ACCESS_KEY_ID}
      secret_access_key: ${OSS_SECRET_ACCESS_KEY}
      s3forcepathstyle: true
      insecure: false
  
  rule_path: /loki/rules-temp
  
  ring:
    kvstore:
      store: inmemory
  
  # 评估间隔
  evaluation_interval: 1m
  poll_interval: 1m

# 表管理配置
table_manager:
  retention_deletes_enabled: true
  retention_period: 720h
  poll_interval: 10m

# 成员列表配置（集群模式可选）
memberlist:
  join_members: []
  dead_node_reclaim_time: 30s
  gossip_to_dead_nodes_time: 15s
  left_ingesters_timeout: 30s
  bind_port: 7946

# 分析统计（可选）
analytics:
  reporting_enabled: false
